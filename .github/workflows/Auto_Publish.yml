on:
  push:
    tags:
    - "v[0-9]+.[0-9]+.[0-9]+"
    - "v[0-9]+.[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:
jobs:
  Check-Branch:
    # see https://stackoverflow.com/a/77727776
    runs-on: ubuntu-latest
    outputs:
      is_on_main: contains(${{ steps.check_step.outputs.branches }}, 'main')
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Get Current Branch
      id: check_step
      run: |
        raw=$(git branch -r --contains ${{ github.ref }})
        branches="$(echo ${raw//origin\//} | tr -d '\n')"
        echo "{name}=branches" >> $GITHUB_OUTPUT
        echo "Branches where this tag exists : $branches."
  Get-Version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
    - id: get-version
      run: |
        version=${GITHUB_REF/refs\/tags\/v/}
        echo "$version"
        echo "{name}=version" >> $GITHUB_OUTPUT
  debug:
    runs-on: ubuntu-latest
    needs: Get-Version
    steps:
    - name: debug
      run: echo ${{ needs.Get-Version.outputs.version }}
  Extensions:
    name: "Publish Extensions"
    needs: [Check-Branch, Get-Version]
    if: ${{ needs.Check-Branch.outputs.is_on_main }}
    uses: ./.github/workflows/NuGet.yml
    with:
      project_path: "./Extensions/Extensions.csproj"
      version: ${{ needs.Get-Version.outputs.version }}
    secrets:
      nuget_key: ${{ secrets.NUGET_API_KEY }}
